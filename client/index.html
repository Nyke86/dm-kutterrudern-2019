<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deutsche Meisterschaft Kutterrudern 2019</title>

    <link rel="stylesheet" type="text/css" href="/css/style.css">

    <script src="/socket.io/socket.io.js"></script>
    <script src="bower_components/rivets/dist/rivets.bundled.min.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <div id="results">
        <h1 class="title">Deutsche Meisterschaft im Kutterrudern 2019</h1>
        <h2 class="title">5.000 Meter - Männer</h2>
        <hr/>
        <div class="legend"><div class="top-sector-time">Schnellste Sektorzeit</div><div class="top-time">Schnellste Zwischenzeit</div></div>
        <table>
            <thead>
                <td>#</td>
                <td>Team</td>
                <td>0,5 km</td>
                <td>1,0 km</td>
                <td>1,5 km</td>
                <td>2,0 km</td>
                <td>2,5 km</td>
                <td>3,0 km</td>
                <td>3,5 km</td>
                <td>4,0 km</td>
                <td>4,5 km</td>
                <td>5,0 km</td>
            </thead>
            <tbody>
                <tr class="boat_1"><td>01</td><td>SSC Rathenow</td><td class="top-sector-time">00:00:00</td><td>00:00:00</td><td class="top-sector-time top-time">00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
                <tr class="boat_2"><td>02</td><td>SSC Wendisch-Rietz</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
                <tr class="boat_3"><td>03</td><td>SSC Greifswald</td><td class="top-time">00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
                <tr class="boat_4"><td>04</td><td>WSC Halle</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
                <tr class="boat_5"><td>05</td><td>Anklamer Hanse-Haie</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
                <tr class="boat_6"><td>06</td><td>Club Maritim Erfurt</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
                <tr class="boat_7"><td>07</td><td>SSV Sömmerda</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
                <tr class="boat_8"><td>08</td><td>Bernburger Maritimer Club</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
                <tr class="boat_9"><td>09</td><td>Leipziger Seesportclub e.V.</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td><td>00:00:00</td></tr>
            </tbody>
        </table>
        <hr/>
        <div class="legend"><div class="top-speed">Höchste Geschwindigkeit</div></div>
        <table id="live_data">
            <thead>
                <tr>
                    <td rowspan="2">#</td>
                    <td rowspan="2">Team</td>
                    <td rowspan="2">Distanz</td>
                    <td rowspan="2">Zeit</td>
                    <td colspan="3">Geschwindigkeit</td>
                </tr>
                <tr>
                    <td>Aktuelle</td>
                    <td>&Oslash;</td>
                    <td>Höchste</td> 
                </tr>
            </thead>
            <tbody>
                <tr rv-class="boat.boat_number | boat_class" rv-each-boat="results.boats">
                  <td>{ boat.boat_number | pad2 }</td>
                  <td>{ boat.name }</td>
                  <td>{ boat.distance | integer} m</td>
                  <td>{ boat.time | time}</td>
                  <td class="top-speed">{ boat.speed | float} km/h</td>
                  <td><span class="arrow-down">&#x25BC;</span> { boat.avg_speed | float } km/h</td> <!-- <span class="arrow-up">&#x25B2;</span> -->
                  <td>{ boat.max_speed | float } km/h</td>
                </tr>
            </tbody>
        </table>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdzshFeTbKPh6syJU6JGQ0ETa23POnCg&callback=initMap" async defer></script>
    <script>
        var map;
        var markerList = [];
        var activeInfoWindow = undefined;
        var activeMarkerIndex = 0;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 52.598, lng: 12.326},
                zoom: 15,
                gestureHandling: 'none',
                zoomControl: false,
                mapTypeControl: false,
                scaleControl: false,
                streetViewControl: false,
                rotateControl: false,
                fullscreenControl: false,
                styles: [
                {
                  "featureType": "administrative.land_parcel",
                  "elementType": "labels",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "administrative.locality",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "administrative.neighborhood",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "landscape.man_made",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "landscape.natural",
                  "stylers": [
                    {
                      "visibility": "on"
                    }
                  ]
                },
                {
                  "featureType": "landscape.natural.landcover",
                  "stylers": [
                    {
                      "visibility": "on"
                    }
                  ]
                },
                {
                  "featureType": "landscape.natural.terrain",
                  "stylers": [
                    {
                      "visibility": "on"
                    }
                  ]
                },
                {
                  "featureType": "poi",
                  "elementType": "labels.text",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "poi.attraction",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "poi.business",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "poi.business",
                  "elementType": "labels",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "poi.government",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "poi.medical",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "poi.school",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "poi.sports_complex",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "road.arterial",
                  "elementType": "labels.icon",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "road.arterial",
                  "elementType": "labels.text",
                  "stylers": [
                    {
                      "visibility": "on"
                    }
                  ]
                },
                {
                  "featureType": "road.highway",
                  "elementType": "labels.icon",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "road.local",
                  "elementType": "labels",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "road.local",
                  "elementType": "labels.icon",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "road.local",
                  "elementType": "labels.text",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "transit.line",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "transit.station",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "water",
                  "elementType": "labels.icon",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
                {
                  "featureType": "water",
                  "elementType": "labels.text",
                  "stylers": [
                    {
                      "visibility": "simplified"
                    }
                  ]
                }
              ]
            });

            showInfoWindow();

            window.setInterval(showInfoWindow, 5*1000);
        }

        function addMarker(location, boat_nr, team_name, map) {
            var marker = new google.maps.Marker({
                position: location,
                label: boat_nr,
                map: map
            });

            markerList.push({
                marker: marker,
                boat_number: boat_nr,
                name: team_name
            });
        }

        function showInfoWindow() {
            if (markerList.length === 0) return;
            if (activeInfoWindow) { activeInfoWindow.close();}

            var highlightedElements = Array.from(document.querySelectorAll(".highlight"));
            for(let index in highlightedElements){
                highlightedElements[index].classList.remove('highlight');
            }

            let marker_data = markerList[activeMarkerIndex];

            var elements = Array.from(document.querySelectorAll(".boat_" + marker_data.boat_number));
            for(let index in elements){
                elements[index].classList.add('highlight');
            }

            let infowindow = new google.maps.InfoWindow({
                content: marker_data.name
            });

            infowindow.open(map, marker_data.marker);

            activeInfoWindow = infowindow;
            activeMarkerIndex =  (activeMarkerIndex + 1) % markerList.length;
        }

        var socket = io();
        var session_id = 1;
        var data = {
          boats: []
        };

        rivets.bind($('#live_data'), {results: data})

        rivets.formatters.time = function(value){
          var sec_num = parseInt(value, 10); // don't forget the second param
          var hours   = Math.floor(sec_num / 3600);
          var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
          var seconds = sec_num - (hours * 3600) - (minutes * 60);

          if (hours   < 10) {hours   = "0"+hours;}
          if (minutes < 10) {minutes = "0"+minutes;}
          if (seconds < 10) {seconds = "0"+seconds;}

          return hours+':'+minutes+':'+seconds;
        }

        rivets.formatters.float = function(value){
          return Number(value).toLocaleString('de-DE', {minimumFractionDigits: 2});
        }

        rivets.formatters.integer = function(value) {
          return Number(value).toLocaleString('de-DE');
        }

        rivets.formatters.pad2 = function(value) {
          var s = String(value);
          while (s.length < 2) {s = "0" + s;}
          return s;
        }

        rivets.formatters.boat_class = function(value) {
          return "boat_" + value;
        }

        socket.on('cutter.race.info', function(msg) {
          //console.log(msg);
        });

        socket.on('cutter.race.feed.split_times', function(msg) {
          //console.log(msg);
        });

        socket.on('cutter.race.feed.live_data', function(results) {
          for(var i = 0; i < results.length; i++) {
            if(results[i].status !== "active")
              continue;

            let team_id = results[i].team_id;

            let index = data.boats.findIndex(x => x.team_id === team_id);

            if( index >= 0 ) {
              data.boats[index].distance = results[i].distance;
              data.boats[index].time = results[i].time;
              data.boats[index].speed = results[i].speed;
              data.boats[index].avg_speed = results[i].avg_speed;
              data.boats[index].max_speed = results[i].max_speed;
            } else {
              data.boats.push(results[i]);
            }

            let boat_number = results[i].boat_number;
            let marker_index = markerList.findIndex(x => x.boat_number === boat_number);

            if(marker_index >= 0) {
              let marker = markerList[marker_index].marker;
              var latlng = new google.maps.LatLng(results[i].position[1], results[i].position[0]);
              marker.setPosition(latlng);
            } else {
              addMarker(
                {lat: results[i].position[1], lng: results[i].position[0]}, 
                results[i].boat_number, 
                results[i].name, 
                map
              );
            }
          }
        });

        socket.emit('cutter.race.init', session_id);
    </script>
  </body>
</html>